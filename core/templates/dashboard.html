{% extends "base.html" %}
{% block content %}

<style>
  .custom-chart {
    width: 100% !important;
    height: 250px !important;
    max-height: 250px;
  }
</style>

{% if exceeded_notifications %}
  <div id="budget-notification" class="notification shadow-sm mb-4" style="opacity: 0;">
      <ul class="mb-0">
          {% for note in exceeded_notifications %}
          <li>{{ note }}</li>
          {% endfor %}
      </ul>
  </div>
{% endif %}

<div id="dashboard-wrapper" class="dashboard-card card shadow mt-1 mb-2" style="opacity: 0; transform: translateY(20px);">
  <div class="card-body">
    <h3 class="mb-3 mt-1">Dashboard Summary</h3>

    <!-- Top Cards -->
    <div class="row mb-3 g-2">
      <div class="col-md-4 dash-card">
        <div class="card text-white border-0 shadow h-100" style="background: linear-gradient(145deg, rgba(0, 200, 200, 0.9), rgba(0, 150, 150, 0.8)); border-radius: 10px;">
          <div class="card-body p-3">
            <h5 class="card-title">Total Income</h5>
            <p class="card-text fs-4 fw-semibold">₹{{ total_income }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 dash-card">
        <div class="card text-white border-0 shadow h-100" style="background: linear-gradient(145deg, rgba(255, 80, 110, 0.9), rgba(255, 30, 70, 0.8)); border-radius: 10px;">
          <div class="card-body p-3">
            <h5 class="card-title">Total Expense</h5>
            <p class="card-text fs-4 fw-semibold">₹{{ total_expense }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 dash-card">
        <div class="card text-white border-0 shadow h-100" style="background: linear-gradient(145deg, rgba(120, 180, 255, 0.9), rgba(70, 130, 255, 0.8)); border-radius: 10px;">
          <div class="card-body p-3">
            <h5 class="card-title">Balance</h5>
            <p class="card-text fs-4 fw-semibold">₹{{ balance }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row mb-3 g-2 chart-section">
      <div class="col-md-6">
        <canvas id="lineChart" class="custom-chart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="doughnutChart" class="custom-chart"></canvas>
      </div>
    </div>

    <!-- Latest Transactions Table -->
    <div class="mb-3">
      <h5 class="mb-2">Latest Transactions</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered mb-0">
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in table %}
            <tr>
              <td>{{ txn.date }}</td>
              <td>{{ txn.description }}</td>
              <td>{{ txn.category }}</td>
              <td>₹{{ txn.amount }}</td>
              <td>
                <form method="post" action="{% url 'delete_transaction' txn.id %}" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">No transactions found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Progress Bars -->
    <div class="row g-2 progress-section">
      <div class="col-md-6">
        <div class="card text-white border-0 shadow h-100" style="background: rgba(0, 0, 0, 0.3); border-radius: 10px;">
          <div class="card-body p-3">
            <h5 class="card-title mb-2">Income Progress</h5>
            <div class="progress" style="height: 18px; background-color: rgba(255, 255, 255, 0.15); border-radius: 8px;">
              <div class="progress-bar income-progress"
                   role="progressbar"
                   style="width: {{ income_progress }}%; background: linear-gradient(90deg, #00ffc3, #00bfa5);"
                   aria-valuenow="{{ income_progress }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
                {{ income_progress }}%
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card text-white border-0 shadow h-100" style="background: rgba(0, 0, 0, 0.3); border-radius: 10px;">
          <div class="card-body p-3">
            <h5 class="card-title mb-2">Expense Progress</h5>
            <div class="progress" style="height: 18px; background-color: rgba(255, 255, 255, 0.15); border-radius: 8px;">
              <div class="progress-bar expense-progress"
                   role="progressbar"
                   style="width: {{ expense_progress }}%; background: linear-gradient(90deg, #ff5c8a, #e60045);"
                   aria-valuenow="{{ expense_progress }}"
                   aria-valuemin="0"
                   aria-valuemax="100">
                {{ expense_progress }}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Anime.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

<script>
  // Notification animation
  if (document.getElementById('budget-notification')) {
    anime({
      targets: '#budget-notification',
      opacity: [0, 1],
      translateY: [-20, 0],
      duration: 600,
      easing: 'easeOutQuad'
    });
    setTimeout(() => {
      anime({
        targets: '#budget-notification',
        opacity: [1, 0],
        duration: 500,
        easing: 'easeInQuad',
        complete: () => document.getElementById('budget-notification').remove()
      });
    }, 2500);
  }

  // Dashboard wrapper fade-in
  anime({
    targets: '#dashboard-wrapper',
    opacity: [0, 1],
    translateY: [20, 0],
    duration: 800,
    easing: 'easeOutExpo'
  });

  // Stagger cards animation
  anime({
    targets: '.dash-card',
    opacity: [0, 1],
    translateY: [30, 0],
    delay: anime.stagger(150, { start: 500 }),
    duration: 700,
    easing: 'easeOutCubic'
  });

  // Charts fade-in
  anime({
    targets: '.chart-section',
    opacity: [0, 1],
    scale: [0.9, 1],
    delay: 1000,
    duration: 700,
    easing: 'easeOutBack'
  });

  // Progress bars animation
  anime({
    targets: '.income-progress',
    width: ['0%', '{{ income_progress }}%'],
    delay: 1200,
    duration: 1000,
    easing: 'easeOutExpo'
  });
  anime({
    targets: '.expense-progress',
    width: ['0%', '{{ expense_progress }}%'],
    delay: 1300,
    duration: 1000,
    easing: 'easeOutExpo'
  });
</script>

<!-- Chart.js Script -->
<script>
const ctxLine = document.getElementById('lineChart');
new Chart(ctxLine, {
    type: 'line',
    data: {
        labels: {{ line_labels|safe }},
        datasets: [
            { label: 'Income', data: {{ line_income|safe }}, borderColor: 'green', fill: false },
            { label: 'Expense', data: {{ line_expense|safe }}, borderColor: 'red', fill: false }
        ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Daily Income vs Expense' } } }
});

const ctxDonut = document.getElementById('doughnutChart');
new Chart(ctxDonut, {
    type: 'doughnut',
    data: { labels: {{ donut_labels|safe }}, datasets: [{ data: {{ donut_data|safe }}, borderWidth: 1 }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Category-wise Breakdown' } } }
});
</script>

<script>
// Function to animate elements when they enter viewport
function animateOnScroll(target, animationProps) {
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        anime({
          targets: entry.target,
          ...animationProps
        });
        obs.unobserve(entry.target); // Animate only once
      }
    });
  }, { threshold: 0.2 });

  document.querySelectorAll(target).forEach(el => observer.observe(el));
}

// Animate table on scroll
animateOnScroll(".table-responsive", {
  opacity: [0, 1],
  translateY: [40, 0],
  duration: 800,
  easing: 'easeOutExpo'
});

// Animate progress bars container on scroll
animateOnScroll(".progress-section", {
  opacity: [0, 1],
  translateX: [-40, 0],
  duration: 800,
  easing: 'easeOutExpo'
});

// Animate charts on scroll
animateOnScroll(".chart-section", {
  opacity: [0, 1],
  scale: [0.8, 1],
  duration: 900,
  easing: 'easeOutBack'
});
</script>


{% endblock %}
